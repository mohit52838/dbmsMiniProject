{% extends 'base.html' %}

{% block title %}View Students - College System{% endblock %}

{% block content %}
<div class="page-header"
    style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap;">
    <div style="flex: 1; min-width: 200px;">
        <h2 style="margin: 0;">Student Records</h2>
    </div>

    <div style="flex: 2; min-width: 280px; display: flex; justify-content: flex-end;">
        <form method="GET" action="{{ url_for('view_students') }}" class="styled-form" style="margin: 0; width: 100%;">
            <div style="display: flex; gap: 0.75rem; align-items: center; width: 100%;">
                <label for="dept_id"
                    style="color: var(--text-muted); margin: 0; white-space: nowrap; font-size: 0.85rem;">Filter:</label>
                <select id="dept_id" name="dept_id" onchange="this.form.submit()"
                    style="margin: 0; padding: 0.5rem 2.25rem 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; flex: 1; min-width: 150px; background-position: right 0.75rem center;">
                    {% if session.get('role') != 'faculty' %}
                    <option value="">All Branches</option>
                    {% endif %}
                    {% for dept in departments %}
                    <option value="{{ dept.dept_id }}" {% if current_dept_id|string==dept.dept_id|string %}selected{%
                        endif %}>{{ dept.dept_name }}</option>
                    {% endfor %}
                </select>
                {% if current_dept_id and session.get('role') != 'faculty' %}
                <a href="{{ url_for('view_students') }}" class="btn btn-secondary btn-sm"
                    style="white-space: nowrap; height: 100%; display: flex; align-items: center;">Clear</a>
                {% endif %}
            </div>
        </form>
    </div>

    <div style="flex: 1; min-width: 200px; display: flex; justify-content: flex-end; gap: 0.5rem;">
        <a href="{{ url_for('export_students', dept_id=request.args.get('dept_id', '')) }}"
            class="btn btn-secondary d-print-none" title="Download as Excel/CSV">üì• CSV</a>
        <button onclick="window.print()" class="btn btn-secondary d-print-none" title="Save as PDF">üñ®Ô∏è Print</button>
        <a href="{{ url_for('add_student') }}" class="btn btn-primary d-print-none" style="justify-content: center;">+
            Add New Student</a>
    </div>
</div>

{% for branch, divisions in reports.items() %}
<div class="list-container mb-4">
    <div class="list-header">
        <h3>{{ branch }}</h3>
    </div>
    {% for division, branch_students in divisions.items() %}
    <h4 class="division-header">Division {{ division }}</h4>
    <div class="table-responsive">
        <table class="styled-table" style="margin-bottom: 0;">
            <thead>
                <tr>
                    <th>Roll No</th>
                    <th>Name</th>
                    <th>Score</th>
                    <th>Grade</th>
                    <th>Attendance %</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for report in branch_students %}
                <tr>
                    <td>{{ report.roll_no }}</td>
                    <td>
                        <strong>{{ report.name }}</strong>
                        <br>
                        <small class="text-muted">{{ report.prn }}</small>
                    </td>
                    <td>
                        {{ report.total_marks_obtained }} / {{ report.max_possible_marks }}
                        <br>
                        <small class="text-muted">{{ "%.2f"|format(report.percentage) }}%</small>
                    </td>
                    <td>
                        {% if report.percentage >= 90 %}
                        <span class="badge bg-success">A</span>
                        {% elif report.percentage >= 75 %}
                        <span class="badge bg-primary">B</span>
                        {% elif report.percentage >= 60 %}
                        <span class="badge bg-info">C</span>
                        {% elif report.percentage >= 40 %}
                        <span class="badge bg-warning">D</span>
                        {% else %}
                        <span class="badge bg-danger">F</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="progress-container">
                            <div class="progress-bar {% if report.attendance_percentage < 75 %}bg-danger{% else %}bg-success{% endif %}"
                                style="width: {{ report.attendance_percentage }}%">
                            </div>
                            <span>{{ report.attendance_percentage }}%</span>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-sm btn-secondary"
                                onclick="showStudentDetails('{{ report.name|escape }}', '{{ report.prn|escape }}', '{{ report.email|escape }}', '{{ report.phone|escape }}', '{{ report.mother_name|escape }}', '{{ report.address|escape }}', '{{ report.roll_no }}', '{{ branch|escape }}', '{{ division|escape }}')">Details</button>
                            <a href="{{ url_for('view_student_marks', id=report.student_id) }}"
                                class="btn btn-sm btn-info" style="color: white">Marks</a>
                            <a href="{{ url_for('update_student', id=report.student_id) }}"
                                class="btn btn-sm btn-primary">Edit</a>
                            <form action="{{ url_for('delete_student', id=report.student_id) }}" method="POST"
                                style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-danger"
                                    onclick="return confirm('Delete this student?')">Delete</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="list-container">
    <div class="text-center" style="padding: 2rem;">No students found.</div>
</div>
{% endfor %}

<!-- Student Details Modal -->
<div id="studentDetailsModal" class="modal-overlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(8px); transition: all 0.3s ease;">
    <div class="modal-content"
        style="background: var(--surface); border-radius: 20px; width: 90%; max-width: 450px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); overflow: hidden; transform: scale(0.95); animation: modalPop 0.3s forwards cubic-bezier(0.175, 0.885, 0.32, 1.275);">

        <!-- Gradient Header with Avatar -->
        <div
            style="background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 2.5rem 2rem 4rem 2rem; text-align: center; position: relative;">
            <button onclick="closeStudentDetails()"
                style="position: absolute; top: 1rem; right: 1.5rem; background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 50%; color: white; font-size: 1.25rem; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(4px); transition: background 0.2s;">
                &times;
            </button>
            <div style="font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem; font-weight: 600;"
                id="modalPrn"></div>
            <h3 style="margin: 0; color: white; font-size: 1.5rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                id="modalStudentName">Student Name</h3>
        </div>

        <!-- Content Body -->
        <div style="padding: 0 2rem 2rem 2rem; position: relative; margin-top: -30px;">
            <!-- Avatar Circle -->
            <div
                style="width: 80px; height: 80px; background: var(--surface); border-radius: 50%; margin: 0 auto 1.5rem auto; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 4px solid var(--surface); color: var(--primary);">
                üë®‚Äçüéì
            </div>

            <!-- Detail Pills -->
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div
                    style="background: var(--background); padding: 0.85rem 1rem; border-radius: 12px; display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="width: 32px; height: 32px; border-radius: 8px; background: rgba(56, 189, 248, 0.1); display: flex; align-items: center; justify-content: center; color: var(--secondary);">
                        üìö</div>
                    <div style="flex: 1;">
                        <div
                            style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">
                            Class & Branch</div>
                        <div style="color: var(--text-main); font-weight: 500; font-size: 0.9rem;" id="modalClass">
                        </div>
                    </div>
                </div>

                <div
                    style="background: var(--background); padding: 0.85rem 1rem; border-radius: 12px; display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="width: 32px; height: 32px; border-radius: 8px; background: rgba(16, 185, 129, 0.1); display: flex; align-items: center; justify-content: center; color: var(--accent);">
                        ‚úâÔ∏è</div>
                    <div style="flex: 1;">
                        <div
                            style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">
                            Email Address</div>
                        <div style="color: var(--text-main); font-weight: 500; font-size: 0.9rem; word-break: break-all;"
                            id="modalEmail"></div>
                    </div>
                </div>

                <div
                    style="background: var(--background); padding: 0.85rem 1rem; border-radius: 12px; display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="width: 32px; height: 32px; border-radius: 8px; background: rgba(59, 130, 246, 0.1); display: flex; align-items: center; justify-content: center; color: var(--info);">
                        üì±</div>
                    <div style="flex: 1;">
                        <div
                            style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">
                            Phone Number</div>
                        <div style="color: var(--text-main); font-weight: 500; font-size: 0.9rem;" id="modalPhone">
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    <div style="background: var(--background); padding: 0.85rem 1rem; border-radius: 12px;">
                        <div
                            style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 0.25rem;">
                            Mother</div>
                        <div style="color: var(--text-main); font-weight: 500; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                            id="modalMother"></div>
                    </div>
                    <div style="background: var(--background); padding: 0.85rem 1rem; border-radius: 12px;">
                        <div
                            style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 0.25rem;">
                            Address</div>
                        <div style="color: var(--text-main); font-weight: 500; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                            id="modalAddress"></div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 1.5rem; text-align: center;">
                <button type="button" class="btn btn-secondary" onclick="closeStudentDetails()"
                    style="width: 100%; border-radius: 10px; padding: 0.75rem; font-weight: 600;">Close Profile</button>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes modalPop {
        to {
            transform: scale(1);
        }
    }
</style>

<script>
    function showStudentDetails(name, prn, email, phone, mother, address, rollNo, branch, division) {
        document.getElementById('modalStudentName').textContent = name;
        document.getElementById('modalPrn').textContent = prn && prn !== 'None' ? prn : 'N/A';
        document.getElementById('modalEmail').textContent = email && email !== 'None' ? email : 'N/A';
        document.getElementById('modalPhone').textContent = phone && phone !== 'None' ? phone : 'N/A';
        document.getElementById('modalMother').textContent = mother && mother !== 'None' ? mother : 'N/A';
        document.getElementById('modalAddress').textContent = address && address !== 'None' ? address : 'N/A';
        document.getElementById('modalClass').textContent = branch + " - Div " + division + " (Roll No: " + (rollNo && rollNo !== 'None' ? rollNo : 'N/A') + ")";

        document.getElementById('studentDetailsModal').style.display = 'flex';
    }

    function closeStudentDetails() {
        document.getElementById('studentDetailsModal').style.display = 'none';
    }

    // Close modal if clicking outside
    window.onclick = function (event) {
        var modal = document.getElementById('studentDetailsModal');
        if (event.target == modal) {
            closeStudentDetails();
        }
    }
</script>

{% endblock %}