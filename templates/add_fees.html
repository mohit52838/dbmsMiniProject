{% extends 'base.html' %}

{% block title %}Add Fees - College System{% endblock %}

{% block content %}
<div class="form-container" style="max-width: 100%;">
    <div class="form-header">
        <h2>Record Student Fees</h2>
        <p>Input fee details to calculate remaining balance automatically</p>
    </div>

    <form method="POST" action="{{ url_for('add_fees') }}" class="styled-form">
        <div class="form-group row">
            <div class="col">
                <label for="department_id">Branch</label>
                <select id="department_id" name="department_id" required onchange="loadDivisionOptions()">
                    <option value="" disabled selected>Select a branch first</option>
                    {% for dept in departments %}
                    <option value="{{ dept.dept_id }}" data-name="{{ dept.dept_name }}">{{ dept.dept_name }}</option>
                    {% endfor %}
                </select>
                <!-- Hidden input to send actual branch name to backend -->
                <input type="hidden" id="branch_name" name="branch_name">
            </div>
            <div class="col">
                <label for="division">Division / Class Year</label>
                <select id="division" name="class_year" required disabled onchange="loadStudents()">
                    <option value="" disabled selected>Select a branch first</option>
                </select>
            </div>
        </div>

        <div class="form-group row">
            <div class="col">
                <label for="student_id">Assign Student</label>
                <select id="student_id" name="student_id" required disabled>
                    <option value="" disabled selected>Select a division first</option>
                </select>
            </div>
        </div>

        <h3 style="margin-top: 1.5rem; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem;">Fee Details</h3>

        <div class="form-group row mb-3" style="align-items: center; margin-top: 1.5rem;">
            <div class="col">
                <label for="total_fees">Total Fees Configured (₹)</label>
                <input type="number" id="total_fees" name="total_fees" min="0" step="0.01" placeholder="e.g. 100000"
                    required>
            </div>
            <div class="col">
                <label for="amount_paid">Amount Paid (₹)</label>
                <input type="number" id="amount_paid" name="amount_paid" min="0" step="0.01" placeholder="e.g. 50000"
                    required>
            </div>
        </div>

        <script>
            async function loadDivisionOptions() {
                const deptSelect = document.getElementById('department_id');
                const deptId = deptSelect.value;

                // Update hidden branch name
                const selectedOption = deptSelect.options[deptSelect.selectedIndex];
                document.getElementById('branch_name').value = selectedOption.getAttribute('data-name');

                const divSelect = document.getElementById('division');
                const studentSelect = document.getElementById('student_id');

                // Reset sub-dropdowns
                divSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';
                divSelect.disabled = true;
                studentSelect.innerHTML = '<option value="" disabled selected>Select a division first</option>';
                studentSelect.disabled = true;

                if (!deptId) return;

                // Fetch divisions
                try {
                    const res = await fetch(`/api/divisions/${deptId}`);
                    const divs = await res.json();
                    divSelect.innerHTML = '<option value="" disabled selected>Select Division/Class Year</option>';
                    divs.forEach(d => {
                        divSelect.innerHTML += `<option value="${d}">${d}</option>`;
                    });
                    divSelect.disabled = false;
                } catch (e) { console.error('Error fetching divisions', e); }
            }

            async function loadStudents() {
                const deptId = document.getElementById('department_id').value;
                const div = document.getElementById('division').value;
                const studentSelect = document.getElementById('student_id');

                studentSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';
                studentSelect.disabled = true;

                if (!deptId || !div) return;

                try {
                    const res = await fetch(`/api/students/${deptId}/${div}`);
                    const students = await res.json();
                    studentSelect.innerHTML = '<option value="" disabled selected>Select Student</option>';
                    students.forEach(s => {
                        studentSelect.innerHTML += `<option value="${s.student_id}">${s.name}</option>`;
                    });
                    studentSelect.disabled = false;
                } catch (e) { console.error('Error fetching students', e); }
            }
        </script>

        <div class="form-actions">
            <a href="{{ url_for('view_fees') }}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">Save Fee Record</button>
        </div>
    </form>
</div>
{% endblock %}